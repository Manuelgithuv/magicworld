name: Auto Release

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  bump-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create tag
        id: tag
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Show tag
        run: |
          echo "New tag raw: '${{ steps.tag.outputs.new_tag }}'"

      - name: Resolve NEW_TAG
        run: |
          # If the tag action produced a new_tag, use it
          if [ "${{ steps.tag.outputs.new_tag }}" != "" ]; then
            echo "NEW_TAG=${{ steps.tag.outputs.new_tag }}" >> $GITHUB_ENV
          # Else, if this workflow was triggered by a tag push, extract the tag name from GITHUB_REF
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            ref_name=${GITHUB_REF#refs/tags/}
            echo "NEW_TAG=$ref_name" >> $GITHUB_ENV
          else
            # No tag available
            echo "NEW_TAG=" >> $GITHUB_ENV
          fi

      - name: Debug NEW_TAG
        run: |
          echo "NEW_TAG (from env): $NEW_TAG"

      - name: Create GitHub Release
        if: ${{ env.NEW_TAG != '' }}
        uses: actions/create-release@v1
        with:
          tag_name: ${{ env.NEW_TAG }}
          release_name: Release ${{ env.NEW_TAG }}
          body: |
            Release autom√°tica creada por workflow.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
